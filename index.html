<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Seoul Trip 2025-26 üå≤</title>
    
    <!-- App Icons & PWA Settings -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå≤</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå≤</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F5F1E8">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'page-bg': '#F5F1E8',       
                        'nav-bg': '#C7D2C8',        
                        'nav-border': '#B3BFB6',
                        'nav-text-active': '#3E5F52', 
                        'nav-text-inactive': '#6F8F83',
                        'sage-main': '#9FB8A9',     
                        'sage-dark': '#8FAF9A',     
                        'sage-light': '#DCE8E1',    
                        'sage-pale': '#E4EFE8',     
                        'text-main': '#3E5F52',     
                        'text-sub': '#748B82',      
                        'func-yellow': '#EBCB8B',   
                        'func-red': '#D68C8C',      
                        'func-blue': '#8FB4C4',
                        'card-warm': '#FBFAF4', // ÊöñÁôΩËÉåÊôØ
                        'card-border': '#E6DFD3', // ÊâãÂ∏≥ÊÑüÈÇäÊ°Ü
                    },
                    fontFamily: { cute: ['"Zen Maru Gothic"', 'sans-serif'] },
                    boxShadow: {
                        'paper': '3px 3px 0px #D3DCD6', 
                        'floating': '0 8px 24px -4px rgba(62, 95, 82, 0.12)', 
                        'sticker': '2px 2px 0px rgba(143, 175, 154, 0.5)',
                        'soft-card': '0 8px 20px rgba(0,0,0,0.08)', // ÊüîÂíåÊâãÂ∏≥Èô∞ÂΩ±
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #F5F1E8; 
            background-image: radial-gradient(#E2E8E4 1.5px, transparent 1.5px); 
            background-size: 24px 24px; 
            color: #3E5F52; 
            font-family: "Zen Maru Gothic", sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            padding-bottom: 140px; 
            min-height: 100vh; 
        }
        
        .safe-top-padding { padding-top: max(5rem, env(safe-area-inset-top)); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* UI Components */
        .ac-input, .ac-textarea, .ac-select { @apply w-full bg-white border-2 border-[#D3DCD6] rounded-3xl px-4 py-2 text-text-main font-bold outline-none focus:border-sage-dark transition shadow-sm; box-sizing: border-box !important; width: 100% !important; max-width: 100% !important; }
        .ac-input::placeholder, .ac-textarea::placeholder { color: #BCCUC6; font-weight: 500; }
        
        /* Updated Input for Expense Section */
        .input-gray-border { @apply border-gray-300 focus:border-sage-dark; }

        .ac-card { background: #FFFFFF; border-radius: 24px; box-shadow: 3px 3px 0px #D3DCD6; border: 2px solid #EFF3F1; overflow: hidden; width: 100%; box-sizing: border-box; }
        
        /* Nav & Tabs */
        .day-tabs-container { display: flex; gap: 8px; padding: 8px 12px; width: 100%; box-sizing: border-box; overflow-x: auto; scrollbar-width: none; }
        .day-tabs-container::-webkit-scrollbar { display: none; }
        .day-pill { flex: 0 0 auto; display: flex; align-items: center; justify-content: center; padding: 8px 16px; border-radius: 9999px; font-size: 13px; font-weight: 700; color: #9FB5A8; background-color: #FFFFFF; border: 2px solid #D3DCD6; transition: all 0.2s; cursor: pointer; box-shadow: 2px 2px 0px #D3DCD6; min-width: 70px; whitespace-nowrap; }
        .day-pill.active { background-color: #DCE8E1; color: #3E5F52; border-color: #8FAF9A; box-shadow: inset 0 2px 4px rgba(62, 95, 82, 0.05); transform: translateY(1px); }
        
        .plan-detail { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: #FAFCFB; }
        .plan-detail.expanded { max-height: 2000px; transition: max-height 0.6s ease-in; border-top: 2px dashed #D3DCD6; position: relative; z-index: 10; }
        
        .segment-control { position: relative; display: flex; background-color: #E4EFE8; border-radius: 999px; padding: 4px; cursor: pointer; border: 2px solid #D3DCD6; width: 220px; margin: 0 auto; height: 52px; user-select: none; }
        .segment-glider { position: absolute; top: 4px; left: 4px; width: calc(50% - 4px); height: calc(100% - 8px); background-color: #FFFFFF; border-radius: 999px; box-shadow: 0 2px 8px rgba(62, 95, 82, 0.1); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 1; }
        .segment-item { flex: 1; text-align: center; z-index: 2; display: flex; align-items: center; justify-content: center; font-size: 15px; font-weight: 800; color: #9FB5A8; transition: color 0.3s ease; position: relative; }
        .segment-control.mode-details .segment-glider { transform: translateX(100%); }
        .segment-control.mode-record .item-record { color: #3E5F52; }
        .segment-control.mode-details .item-details { color: #3E5F52; }
        
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .calc-btn { @apply text-xl font-bold rounded-3xl active:scale-95 transition-transform flex items-center justify-center select-none cursor-pointer shadow-sm h-14 border-2 border-[#E4EFE8] bg-white text-text-main; }
        .calc-eq { @apply bg-sage-dark text-white border-sage-dark; }
        .modal-overlay { background: rgba(62, 95, 82, 0.4); backdrop-filter: blur(4px); }
        
        /* Nav */
        .nav-btn { @apply flex-1 flex flex-row items-center justify-center gap-1.5 h-12 rounded-full transition-all font-bold tracking-widest; color: #6F8F83; }
        .nav-btn i { @apply text-xl mb-0.5; } 
        .nav-btn span { @apply text-[13px]; }
        .nav-btn.active { @apply bg-[#F7F4EB] text-nav-text-active shadow-sm; }
        .bottom-nav { height: 5.5rem; }
        
        #app { min-height: 100vh; padding-bottom: 160px; }
        
        /* Checkbox */
        .cb-container { display: block; position: relative; padding-left: 35px; margin-bottom: 12px; cursor: pointer; font-size: 16px; user-select: none; }
        .cb-container input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .checkmark { position: absolute; top: 0; left: 0; height: 24px; width: 24px; background-color: #fff; border-radius: 8px; border: 2px solid #D3DCD6; }
        .cb-container:hover input ~ .checkmark { background-color: #E4EFE8; }
        .cb-container input:checked ~ .checkmark { background-color: #8FAF9A; border-color: #8FAF9A; }
        .checkmark:after { content: ""; position: absolute; display: none; }
        .cb-container input:checked ~ .checkmark:after { display: block; }
        .cb-container .checkmark:after { left: 8px; top: 4px; width: 6px; height: 12px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
        .item-text { transition: all 0.2s; color: #3E5F52; }
        .cb-container input:checked ~ .item-text { text-decoration: line-through; color: #9FB5A8; }
        
        /* Buttons */
        .btn-primary { @apply bg-sage-dark text-white border-2 border-sage-dark shadow-sm hover:opacity-90 active:scale-95 transition; }
        .btn-secondary { @apply bg-white text-text-main border-2 border-[#D3DCD6] shadow-sm hover:bg-sage-pale active:scale-95 transition; }
        .btn-accent { @apply bg-func-yellow text-[#6B4F1D] border-2 border-[#D6C095] shadow-sm hover:opacity-90 active:scale-95 transition; }

        /* Shop Styles - Planner Theme */
        .shop-tabs { display: flex; gap: 8px; overflow-x: auto; padding: 12px 16px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .shop-tabs::-webkit-scrollbar { display: none; }
        
        .shop-tab-btn { 
            @apply flex-shrink-0 px-5 py-2.5 rounded-full text-sm font-bold border transition-all duration-300;
            @apply bg-card-warm text-sage-dark border-card-border shadow-sm;
        }
        .shop-tab-btn:active { @apply scale-95; }
        .shop-tab-btn.active { 
            @apply bg-sage-dark text-white border-sage-dark shadow-sticker -translate-y-1; 
        }
        
        /* Grid Layout (Strict Structure) */
        .shop-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 20px; 
            padding-bottom: 100px;
            padding-top: 10px;
            align-items: start; 
        }
        @media (min-width: 768px) { .shop-grid { grid-template-columns: repeat(3, 1fr); } }
        
        /* Shop Card: Structural Integrity */
        .shop-card { 
            @apply flex flex-col h-auto w-full transition-all duration-300;
            background-color: #FBFAF4; 
            border: 1px solid #E6DFD3; 
            border-radius: 20px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); 
            overflow: hidden; 
        }
        
        .shop-card-img-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            position: relative;
            background-color: #F5F5F5;
        }
        
        .shop-card-body {
            display: flex;
            flex-direction: column;
            padding: 12px 16px 16px 16px;
        }

        .shop-card.purchased { 
            background-color: #F0F0F0;
        }
        .shop-card.purchased img {
            filter: grayscale(100%);
            opacity: 0.7;
        }
        .shop-card.purchased h4, 
        .shop-card.purchased p {
            color: #999;
            text-decoration: line-through;
        }
        
        .badge-purchased {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg) scale(0);
            background-color: rgba(62, 95, 82, 0.95);
            color: white; font-size: 14px; font-weight: bold;
            padding: 6px 16px; border-radius: 50px; border: 2px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 20; pointer-events: none;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .shop-card.purchased .badge-purchased { transform: translate(-50%, -50%) rotate(-15deg) scale(1); }
        
        .check-circle { 
            position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; 
            background: rgba(255,255,255,0.9); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; z-index: 30; 
            border: 1px solid #D3DCD6;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            cursor: pointer; 
            transition: transform 0.2s;
        }
        .check-circle:active { transform: scale(0.9); }
        .check-circle::after { content: ''; width: 16px; height: 16px; border-radius: 50%; background-color: #D3DCD6; transition: background-color 0.2s; }
        .shop-card.purchased .check-circle::after { background-color: #3E5F52; }

        .dep-btn { 
            @apply w-full py-3 rounded-2xl font-bold border-2 transition-all duration-200 shadow-sm;
            @apply bg-white text-text-sub border-[#D3DCD6]; 
        }
        .dep-btn:hover { @apply opacity-90; }
        .dep-btn:active { @apply scale-95; }
        .dep-btn.active { 
            @apply bg-sage-dark text-white border-sage-dark shadow-md transform scale-[1.02]; 
        }
    </style>
</head>
<body class="font-cute">

    <script>
        const ITINERARY_API_URL = 'https://script.google.com/macros/s/AKfycbzxqo9i1PjYYvv96O041LQWY6PsC3M4tIAVT93puATbWuYOAj9g_C8p2oBS2lEDuit3/exec'; 
        const WALLET_API_URL    = 'https://script.google.com/macros/s/AKfycbx4UGXPQcYj1llewcfCKw86EGRbUVr2GZlSDOg0VO6fsGiGoVn1NCzmbYKCpceLuvex/exec'; 
        const CHECKLIST_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTUFJYS6U-wqQv6d9AI-V0iW7DNsREniGC5OhzV-RCpOSJaqicfaN5i4LuXgDhlJy8LF2FcCVNx3l79/pub?output=csv';
        const SHOP_CSV_URL      = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vREVSza-V5N2uH1DUq5EVG9XNlvLN_bgat8Z4kXXN-2Qu_gyXLeXnE1hVqVyBjHkdOO2snjvOSQk9wa/pub?output=csv';
    </script>

    <!-- Header -->
    <div class="fixed top-0 left-0 right-0 z-50 bg-[#F5F1E8]/95 backdrop-blur-md px-4 pt-10 pb-2 border-b border-[#D3DCD6]">
        <div class="flex justify-between items-center mb-1 px-1 pt-2">
            <h1 class="text-xl font-black text-text-main tracking-wide flex items-center gap-2"><span class="text-2xl">üå≤</span> SEOUL 2026</h1>
            <div id="syncStatus" class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full border border-[#D3DCD6] shadow-sm cursor-pointer hover:bg-white/80 transition active:scale-95" onclick="window.loadAllData()">
                <div id="syncDot" class="w-2 h-2 rounded-full bg-gray-300"></div><span id="syncText" class="text-xs font-bold text-gray-400">ËÆÄÂèñ‰∏≠</span>
            </div>
        </div>
        
        <div class="hidden" id="dayTabsContainer"></div>
        <div class="hidden pb-1 mt-2" id="walletToggleWrapper">
            <div id="walletToggle" class="segment-control mode-record" onclick="window.toggleWalletMode()">
                <div class="segment-glider"></div>
                <div class="segment-item item-record"><i class="fa-solid fa-pen-to-square mr-2"></i>Ë®òÂ∏≥</div>
                <div class="segment-item item-details"><i class="fa-solid fa-list-ul mr-2"></i>ÊòéÁ¥∞</div>
            </div>
        </div>
        <div class="hidden pb-1 mt-2" id="shopTabsContainer">
            <div class="shop-tabs" id="shopTabs"></div>
        </div>
    </div>

    <main id="app" class="safe-top-padding px-4 max-w-md mx-auto relative z-10 pt-48"></main>

    <!-- Modals -->
    <div id="syncModal" class="fixed inset-0 modal-overlay z-[90] hidden flex items-center justify-center p-4 fade-in">
        <div class="ac-card p-6 w-auto bg-white flex flex-col items-center rounded-3xl">
            <div class="animate-spin text-3xl mb-3 text-sage-dark"><i class="fa-solid fa-circle-notch"></i></div>
            <div class="font-bold text-text-main">‚òÅÔ∏è Ë≥áÊñôÂêåÊ≠•‰∏≠...</div>
        </div>
    </div>

    <div id="deleteModal" class="fixed inset-0 modal-overlay z-[80] hidden flex items-center justify-center p-4 fade-in">
        <div class="ac-card p-6 w-full max-w-sm text-center bg-white rounded-[2.5rem]">
            <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl text-func-red"><i class="fa-solid fa-trash-can"></i></div>
            <h3 class="text-xl font-black text-text-main mb-2">Á¢∫ÂÆöË¶ÅÂà™Èô§ÂóéÔºü</h3>
            <p id="delMsg" class="text-sm text-text-sub mb-2">Á¢∫Ë™çÂæåÂ∞áÁÑ°Ê≥ïÂæ©Âéü</p>
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="document.getElementById('deleteModal').classList.add('hidden')" class="py-2 rounded-full font-bold bg-sage-pale text-text-main">ÂèñÊ∂à</button>
                <button onclick="window.confirmDelete()" class="py-2 rounded-full font-bold bg-func-red text-white">Á¢∫Ë™çÂà™Èô§</button>
            </div>
        </div>
    </div>

    <div id="depositModal" class="fixed inset-0 modal-overlay z-[80] hidden flex items-center justify-center p-4 fade-in">
        <div class="ac-card p-6 w-full max-w-sm bg-white rounded-[2.5rem]">
            <h3 class="text-xl font-bold text-text-main mb-4 text-center">üí∞ ÂÖ¨Ë≤ªÂÖ•Èáë</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="window.setDepositSource('ü¶Å')" class="dep-btn" data-source="ü¶Å">ü¶Å Âá∫Ë≥á</button>
                    <button onclick="window.setDepositSource('üê±')" class="dep-btn" data-source="üê±">üê± Âá∫Ë≥á</button>
                    <button onclick="window.setDepositSource('ÂÖ©‰∫∫')" class="dep-btn col-span-2" data-source="ÂÖ©‰∫∫">ü§ù ÂêÑÂá∫‰∏ÄÂçä</button>
                </div>
                <input type="hidden" id="depositSource">
                <div class="relative flex items-center">
                    <span class="absolute left-4 text-text-sub font-bold text-lg">‚Ç©</span>
                    <input type="number" id="depositAmount" placeholder="Ëº∏ÂÖ•ÂÖ•ÈáëÈáëÈ°ç" class="ac-input pl-10 text-lg font-bold py-3">
                </div>
                <div class="select-wrapper mt-2">
                    <select id="depDate" class="ac-select text-center">
                        <option value="12/31">12/31</option>
                        <option value="01/01">01/01</option>
                        <option value="01/02">01/02</option>
                        <option value="01/03">01/03</option>
                    </select>
                </div>
                <button onclick="window.submitDeposit()" class="ac-btn w-full btn-accent font-bold py-3.5 mt-2 rounded-3xl bg-func-yellow text-[#6B4F1D] shadow-sm hover:opacity-90">Á¢∫Ë™çÂ≠òÂÖ•</button>
                <button onclick="document.getElementById('depositModal').classList.add('hidden')" class="w-full text-text-sub text-sm mt-2 font-bold hover:underline text-center block bg-gray-100 rounded-full py-3 hover:bg-gray-200 transition">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <!-- Calculator Modal: Refined UI -->
    <div id="calcModal" class="fixed inset-0 bg-black/30 z-[60] hidden flex flex-col justify-end fade-in backdrop-blur-sm">
        <div class="bg-white rounded-t-[2.5rem] p-6 shadow-2xl safe-bottom">
            <div class="flex justify-between items-center mb-6">
                <span class="text-text-main font-bold text-xl ml-2">üî¢ Ë®àÁÆóÊ©ü</span>
                <button onclick="window.closeCalc()" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <!-- Display Screen -->
            <div class="bg-[#F7F4EB] border-2 border-[#D3DCD6] p-4 rounded-3xl mb-6 text-right text-4xl font-mono text-text-main h-24 flex items-center justify-end font-bold shadow-inner" id="calcDisplay">0</div>
            
            <!-- Keypad Grid -->
            <div class="calc-grid">
                <!-- Row 1: Actions -->
                <div class="calc-btn calc-action" onclick="window.calcClear()">C</div>
                <div class="calc-btn calc-action" onclick="window.calcBackspace()">‚å´</div>
                <div class="calc-btn calc-op" onclick="window.calcAppend('/')">√∑</div>
                <div class="calc-btn calc-op" onclick="window.calcAppend('*')">√ó</div>
                
                <!-- Row 2 -->
                <div class="calc-btn calc-num" onclick="window.calcAppend('7')">7</div>
                <div class="calc-btn calc-num" onclick="window.calcAppend('8')">8</div>
                <div class="calc-btn calc-num" onclick="window.calcAppend('9')">9</div>
                <div class="calc-btn calc-op" onclick="window.calcAppend('-')">‚àí</div>
                
                <!-- Row 3 -->
                <div class="calc-btn calc-num" onclick="window.calcAppend('4')">4</div>
                <div class="calc-btn calc-num" onclick="window.calcAppend('5')">5</div>
                <div class="calc-btn calc-num" onclick="window.calcAppend('6')">6</div>
                <div class="calc-btn calc-op" onclick="window.calcAppend('+')">+</div>
                
                <!-- Row 4 -->
                <div class="calc-btn calc-num" onclick="window.calcAppend('1')">1</div>
                <div class="calc-btn calc-num" onclick="window.calcAppend('2')">2</div>
                <div class="calc-btn calc-num" onclick="window.calcAppend('3')">3</div>
                
                <!-- Row 5 (Equal spans 2 rows visually or sits bottom right) -->
                <!-- Let's do standard grid: 0 spans 2 cols -->
                <div class="calc-btn calc-eq row-span-2 flex flex-col justify-center h-full" style="grid-column: 4; grid-row: 4 / span 2;" onclick="window.calcConfirm()">=</div>
                
                <div class="calc-btn calc-num col-span-2" style="grid-column: 1 / span 2;" onclick="window.calcAppend('0')">0</div>
                <div class="calc-btn calc-num" onclick="window.calcAppend('.')">.</div>
            </div>
        </div>
    </div>
    
    <!-- Nav Bar -->
    <nav class="fixed bottom-6 left-6 right-6 bottom-nav bg-nav-bg rounded-[32px] shadow-floating z-50 flex justify-between items-center px-6 border-2 border-nav-border">
        <button onclick="window.router('plan')" class="nav-btn" data-target="plan">
            <i class="fa-solid fa-calendar-day"></i>
            <span>Ë°åÁ®ã</span>
        </button>
        <button onclick="window.router('wallet')" class="nav-btn" data-target="wallet">
            <i class="fa-solid fa-wallet"></i>
            <span>Ë®òÂ∏≥</span>
        </button>
        <button onclick="window.router('list')" class="nav-btn" data-target="list">
            <i class="fa-solid fa-list-check"></i>
            <span>Ê∏ÖÂñÆ</span>
        </button>
        <button onclick="window.router('shop')" class="nav-btn" data-target="shop">
            <i class="fa-solid fa-bag-shopping"></i>
            <span>ÂøÖË≤∑</span>
        </button>
    </nav>

    <!-- MODULE SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // === Configuration ===
        const ITINERARY_API_URL = 'https://script.google.com/macros/s/AKfycbzxqo9i1PjYYvv96O041LQWY6PsC3M4tIAVT93puATbWuYOAj9g_C8p2oBS2lEDuit3/exec'; 
        const WALLET_API_URL    = 'https://script.google.com/macros/s/AKfycbx4UGXPQcYj1llewcfCKw86EGRbUVr2GZlSDOg0VO6fsGiGoVn1NCzmbYKCpceLuvex/exec'; 
        const CHECKLIST_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTUFJYS6U-wqQv6d9AI-V0iW7DNsREniGC5OhzV-RCpOSJaqicfaN5i4LuXgDhlJy8LF2FcCVNx3l79/pub?output=csv';
        const SHOP_CSV_URL      = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vREVSza-V5N2uH1DUq5EVG9XNlvLN_bgat8Z4kXXN-2Qu_gyXLeXnE1hVqVyBjHkdOO2snjvOSQk9wa/pub?output=csv';

        const config = { currencyRate: 0.024 }; 
        const staticData = {
            itinerary: [ { day: 'Day 1', date: '12/31', events: [] }, { day: 'Day 2', date: '01/01', events: [] }, { day: 'Day 3', date: '01/02', events: [] }, { day: 'Day 4', date: '01/03', events: [] } ],
            payers: ['ÂÖ¨Ë≤ªÊîØ‰ªò', 'Andy ÊîØ‰ªò', 'Lynn ÊîØ‰ªò'],
            paymentMethods: ['ÁèæÈáë', '‰ø°Áî®Âç°', 'T-money', 'Ë°åÂãïÊîØ‰ªò'],
            categories: ['È§êÈ£≤', 'Ë≥ºÁâ©', 'ÈñÄÁ•®', '‰∫§ÈÄö', '‰ΩèÂÆø', 'ÂÖ∂‰ªñ']
        };

        // State & Cache Logic
        let state = {
            activeTab: 'plan', activeDay: 0,
            walletMode: 'record', walletDay: 0, walletFilter: 'all', expenseCurrency: 'KRW',
            itinerary: staticData.itinerary,
            expenses: [], 
            expandedEvents: [], deleteTargetId: null, deleteType: null, editingId: null, editingEventId: null,
            checklist: [], 
            checkedItems: JSON.parse(localStorage.getItem('checkedItems') || '{}'),
            shopProducts: [], shopPurchased: {}, shopFilter: 'All',
            expandedCategories: []
        };

        // Load Cache
        const cachedState = localStorage.getItem('seoul2026_cache');
        if (cachedState) {
            try {
                const parsed = JSON.parse(cachedState);
                if (parsed.itinerary) state.itinerary = parsed.itinerary;
                if (parsed.expenses) state.expenses = parsed.expenses;
                if (parsed.checklist) state.checklist = parsed.checklist;
                if (parsed.shopProducts) state.shopProducts = parsed.shopProducts;
                console.log("Loaded from Cache");
            } catch(e) { console.warn("Cache parse error"); }
        }

        // Firebase Setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let auth, db;

        // Initialize Firebase logic (Executed at bottom)
        
        // Helpers
        function formatMoney(n) { return Math.round(n).toLocaleString('en-US'); }
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        
        function normalizeDate(d) {
            if (!d) return '12/31';
            let str = String(d).trim();
            if (/^\d{1,2}\/\d{1,2}$/.test(str)) {
                let parts = str.split('/');
                return parts[0].padStart(2,'0') + '/' + parts[1].padStart(2,'0');
            }
            if (str.includes('T') && (str.includes('Z') || str.includes('+'))) {
                try {
                    let date = new Date(str);
                    let utc = date.getTime() + (date.getTimezoneOffset() * 60000);
                    let seoulDate = new Date(utc + (3600000 * 9));
                    let mm = String(seoulDate.getMonth() + 1).padStart(2, '0');
                    let dd = String(seoulDate.getDate()).padStart(2, '0');
                    return `${mm}/${dd}`;
                } catch (e) {}
            }
            if (str.includes('T')) str = str.split('T')[0];
            let match = str.match(/(\d{4})?[.\/-]?(\d{1,2})[.\/-](\d{1,2})/);
            if (match) {
                return match[2].padStart(2, '0') + '/' + match[3].padStart(2, '0');
            }
            return str; 
        }

        function normalizeTime(t) {
            if (!t) return '';
            let str = String(t).trim();
            if (str.includes('T') && str.endsWith('Z')) {
                try {
                    let date = new Date(str);
                    let hh = String(date.getHours()).padStart(2, '0');
                    let mm = String(date.getMinutes()).padStart(2, '0');
                    return `${hh}:${mm}`;
                } catch(e) {}
            }
            if (str.includes('T')) {
                let match = str.match(/T(\d{2}:\d{2})/);
                if (match) return match[1];
            }
            return str.substring(0, 5);
        }

        function ensureProtocol(url) {
            if (!url) return '';
            url = url.trim();
            if(url.length < 3) return '';
            return url.match(/^https?:\/\//i) ? url : 'https://' + url;
        }
        function getGoogleDriveId(url) {
            if (!url || !url.includes('drive.google.com')) return '';
            try {
                if (url.includes('/file/d/')) return url.split('/file/d/')[1].split('/')[0];
                if (url.includes('id=')) return url.split('id=')[1].split('&')[0];
            } catch (e) { return ''; }
            return '';
        }

        function saveCache() {
            const cache = {
                itinerary: state.itinerary,
                expenses: state.expenses,
                checklist: state.checklist,
                shopProducts: state.shopProducts
            };
            localStorage.setItem('seoul2026_cache', JSON.stringify(cache));
        }

        // --- Core Functions (Moved Up) ---
        function toggleWalletMode() {
            state.walletMode = state.walletMode === 'record' ? 'details' : 'record';
            render();
        }

        function toggleCurrency() {
            state.expenseCurrency = state.expenseCurrency === 'KRW' ? 'TWD' : 'KRW';
            const btn = document.getElementById('currBtn');
            if(btn) btn.innerText = state.expenseCurrency === 'KRW' ? '‚Ç©' : 'NT$';
        }

        function toggleUneven(val) {
            const box = document.getElementById('unevenBox');
            if(val === '‰∏çÂπ≥ÂùáÂàÜÊî§') box.classList.remove('hidden');
            else box.classList.add('hidden');
        }

        function autoCalcSplit(type) {
            const total = parseFloat(document.getElementById('exAmt').value) || 0;
            const spAndy = document.getElementById('spAndy');
            const spLynn = document.getElementById('spLynn');
            
            if (type === 'total') {
                if(!document.getElementById('unevenBox').classList.contains('hidden')) {
                     spAndy.value = total / 2;
                     spLynn.value = total / 2;
                }
            } else if (type === 'andy') {
                const andyVal = parseFloat(spAndy.value) || 0;
                spLynn.value = Math.max(0, total - andyVal);
            } else if (type === 'lynn') {
                const lynnVal = parseFloat(spLynn.value) || 0;
                spAndy.value = Math.max(0, total - lynnVal);
            }
        }

        function submitExpense() {
            const amt = parseFloat(document.getElementById('exAmt').value);
            if(!amt) return alert('Ë´ãËº∏ÂÖ•ÈáëÈ°ç');
            
            const item = {
                id: state.editingId || generateId(),
                date: document.getElementById('exDate').value,
                payer: document.getElementById('exPayer').value,
                method: document.getElementById('exMethod').value,
                amount: amt,
                currency: state.expenseCurrency,
                cat: document.getElementById('exCat').value,
                name: document.getElementById('exName').value,
                note: document.getElementById('exNote').value,
                time: document.getElementById('exTime').value,
                split: document.getElementById('exSplit').value,
                customSplit: {
                    andy: parseFloat(document.getElementById('spAndy').value)||0,
                    lynn: parseFloat(document.getElementById('spLynn').value)||0
                }
            };
            
            if(state.editingId) {
                const idx = state.expenses.findIndex(e => e.id === state.editingId);
                if(idx !== -1) state.expenses[idx] = item;
                state.editingId = null;
            } else {
                state.expenses.push(item);
            }
            
            syncData('expense', state.editingId ? 'update' : 'add', { item: item });
            saveCache();
            render();
            alert('Â∑≤ÂÑ≤Â≠ò');
        }

        function deleteExpense(id) {
            state.deleteTargetId = id;
            state.deleteType = 'expense';
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function editExpense(id) {
            state.editingId = id;
            state.walletMode = 'record';
            state.activeTab = 'wallet';
            render();
        }

        function cancelEdit() {
            state.editingId = null;
            render();
        }

        function openDepositModal() {
            document.getElementById('depositModal').classList.remove('hidden');
        }

        function setDepositSource(src) {
            document.getElementById('depositSource').value = src;
            document.querySelectorAll('.dep-btn').forEach(b => {
                if(b.dataset.source === src) {
                    b.classList.add('active');
                } else {
                    b.classList.remove('active');
                }
            });
        }

        function submitDeposit() {
            const amt = parseFloat(document.getElementById('depositAmount').value);
            const src = document.getElementById('depositSource').value;
            const date = document.getElementById('depDate').value;
            
            if(!amt || !src) return alert('Ë´ãÂ°´ÂØ´ÂÆåÊï¥');
            
            const item = {
                id: generateId(),
                date: date,
                cat: 'ÂÖ¨Ë≤ªÂÖ•Èáë',
                amount: amt,
                currency: 'KRW', 
                payer: src,
                method: 'ÁèæÈáë',
                name: 'ÂÖ¨Ë≤ªÂÑ≤ÂÄº',
                time: new Date().toTimeString().slice(0,5)
            };
            
            state.expenses.push(item);
            syncData('expense', 'add', { item: item });
            saveCache();
            document.getElementById('depositModal').classList.add('hidden');
            render();
        }

        function openCalc() { document.getElementById('calcModal').classList.remove('hidden'); calcClear(); }
        function closeCalc() { document.getElementById('calcModal').classList.add('hidden'); }
        function calcAppend(val) { 
            const d = document.getElementById('calcDisplay');
            if(d.innerText === '0') d.innerText = val;
            else d.innerText += val;
        }
        function calcClear() { document.getElementById('calcDisplay').innerText = '0'; }
        function calcBackspace() {
            const d = document.getElementById('calcDisplay');
            if(d.innerText.length > 1) d.innerText = d.innerText.slice(0, -1);
            else d.innerText = '0';
        }
        function calcConfirm() {
            try {
                const res = eval(document.getElementById('calcDisplay').innerText);
                document.getElementById('exAmt').value = Math.floor(res);
                closeCalc();
                autoCalcSplit('total');
            } catch(e) { document.getElementById('calcDisplay').innerText = 'Error'; }
        }

        function toggleEvent(id) {
            if(state.expandedEvents.includes(id)) {
                state.expandedEvents = state.expandedEvents.filter(e => e !== id);
            } else {
                state.expandedEvents.push(id);
            }
            render();
        }

        function startEdit(id) {
            state.editingEventId = id;
            if(!state.expandedEvents.includes(id)) state.expandedEvents.push(id);
            render();
        }

        function updateVal(id, field, val) {
            const day = state.itinerary[state.activeDay];
            const evt = day.events.find(e => e.id === id);
            if(evt) evt[field] = val;
        }

        function saveAndClose(id) {
            const day = state.itinerary[state.activeDay];
            const evt = day.events.find(e => e.id === id);
            state.editingEventId = null;
            saveCache();
            render();
            if(evt) syncData('itinerary', 'update', { dayIdx: state.activeDay, event: evt });
        }

        function addEvent() {
            const newId = generateId();
            const newEvt = { id: newId, time: '00:00', title: 'Êñ∞Ë°åÁ®ã', cost: '', transport: '', note: '', link: '' };
            state.itinerary[state.activeDay].events.push(newEvt);
            state.editingEventId = newId;
            state.expandedEvents.push(newId);
            render();
            syncData('itinerary', 'add', { dayIdx: state.activeDay, event: newEvt });
        }

        function askDelete(id) {
            state.deleteTargetId = id;
            state.deleteType = 'event';
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function confirmDelete() {
             if(state.deleteType === 'event') {
                 const day = state.itinerary[state.activeDay];
                 day.events = day.events.filter(e => e.id !== state.deleteTargetId);
                 syncData('itinerary', 'delete', { dayIdx: state.activeDay, event: { id: state.deleteTargetId } });
             } else if (state.deleteType === 'expense') {
                 state.expenses = state.expenses.filter(e => e.id !== state.deleteTargetId);
                 syncData('expense', 'delete', { id: state.deleteTargetId });
             }
             state.deleteTargetId = null;
             document.getElementById('deleteModal').classList.add('hidden');
             saveCache();
             render();
        }

        function setupShopTabs() {
            const container = document.getElementById('shopTabs');
            const locations = new Set();
            state.shopProducts.forEach(item => {
                const loc = item['Location'] || item['Âú∞Èªû'] || 'Other';
                if(loc) locations.add(loc.trim());
            });
            let html = `<button onclick="window.filterShop('All')" class="shop-tab-btn ${state.shopFilter==='All'?'active':''}">ÂÖ®ÈÉ®</button>`;
            locations.forEach(loc => {
                html += `<button onclick="window.filterShop('${loc}')" class="shop-tab-btn ${state.shopFilter===loc?'active':''}">üìç${loc}</button>`;
            });
            container.innerHTML = html;
        }

        async function toggleShopItem(e, name) {
            if(e) e.stopPropagation();
            const isPurchased = !!state.shopPurchased[name];
            const newState = !isPurchased;
            state.shopPurchased[name] = newState;
            
            const checkBtn = e.target;
            const card = checkBtn.closest('.shop-card');
            if (card) {
                if (newState) card.classList.add('purchased');
                else card.classList.remove('purchased');
            }
            saveCache();
            try {
                if (db) {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'shopping_list_status', name);
                    if (newState) await setDoc(ref, { isPurchased: true });
                    else await deleteDoc(ref);
                }
            } catch(err) { console.error("Shop Sync Error", err); }
        }

        function router(tab) {
            state.activeTab = tab;
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const target = btn.dataset.target;
                if(target === tab) {
                    btn.classList.add('active'); 
                    btn.classList.remove('text-nav-inactive');
                } else {
                    btn.classList.remove('active');
                    btn.classList.add('text-nav-inactive');
                }
            });
            render(); 
            window.scrollTo(0,0);
        }

        function switchDay(index) {
            if (state.activeTab === 'plan') {
                state.activeDay = index;
            } else if (state.activeTab === 'wallet') {
                state.walletDay = index;
            }
            render();
        }

        function filterShop(filter) {
            state.shopFilter = filter;
            render();
        }
        
        function toggleCheck(item) {
            state.checkedItems[item] = !state.checkedItems[item];
            localStorage.setItem('checkedItems', JSON.stringify(state.checkedItems));
            render();
        }

        function toggleCategory(cat) {
            if (state.expandedCategories.includes(cat)) {
                state.expandedCategories = state.expandedCategories.filter(c => c !== cat);
            } else {
                state.expandedCategories.push(cat);
            }
            render();
        }

        // --- Data Sync ---
        function syncData(type, action, data) {
            let targetUrl = '';
            let payload = { action: action };

            if (type === 'itinerary') {
                targetUrl = ITINERARY_API_URL;
                if(action === 'delete') {
                    payload.id = data.event.id;
                    const currentDayObj = state.itinerary[data.dayIdx];
                    payload.sheetName = currentDayObj.day;
                } else {
                    const currentDayObj = state.itinerary[data.dayIdx];
                    payload.sheetName = (data.event && data.event.sheetName) ? data.event.sheetName : currentDayObj.day;
                    if (data.event) {
                        payload.id = data.event.id;
                        payload.day = currentDayObj.day; 
                        payload.date = currentDayObj.date;
                        payload.time = data.event.time || '';
                        payload.title = data.event.title || '';
                        payload.transport = data.event.transport || '';
                        payload.food = data.event.food || ''; 
                        payload.cost = data.event.cost || '';
                        payload.link = data.event.link || '';
                        payload.note = data.event.note || '';
                    }
                }
            } else if (type === 'expense') {
                targetUrl = WALLET_API_URL;
                if(action === 'delete') payload.id = data.id;
                else payload.item = data.item;
            }

            const dot = document.getElementById('syncDot');
            const txt = document.getElementById('syncText');
            if(dot) dot.className = 'w-2 h-2 rounded-full bg-btn-yellow animate-pulse';
            if(txt) txt.innerText = 'ÂÇ≥ÈÄÅ‰∏≠...';

            return fetch(targetUrl, { 
                method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'text/plain'}, body: JSON.stringify(payload) 
            }).then(() => {
                if(dot) dot.className = 'w-2 h-2 rounded-full bg-sage-dark';
                if(txt) txt.innerText = 'Â∑≤ÂÑ≤Â≠ò';
                setTimeout(() => { if(txt) txt.innerText = 'Â∑≤ÂêåÊ≠•'; }, 2000);
            }).catch(e => { console.error("Sync Error", e); });
        }

        function loadAllData() {
            const btn = document.getElementById('syncText'); const dot = document.getElementById('syncDot');
            if(btn) btn.innerText = 'ËÆÄÂèñ‰∏≠...'; if(dot) dot.className = 'w-2 h-2 rounded-full bg-btn-yellow animate-pulse';
            
            const p1 = fetch(ITINERARY_API_URL + '?t=' + Date.now()).then(r => r.ok ? r.json() : []);
            const p2 = fetch(WALLET_API_URL + '?t=' + Date.now()).then(r => r.ok ? r.json() : []);
            
            try { loadChecklistData(); } catch(e) { console.error("Checklist load failed", e); }
            try { loadShopData(); } catch(e) { console.error("Shop load failed", e); }

            Promise.all([p1, p2])
                .then(([itinData, walletData]) => {
                    if (Array.isArray(itinData)) {
                        const newItinerary = [ { day: 'Day 1', date: '12/31', events: [] }, { day: 'Day 2', date: '01/01', events: [] }, { day: 'Day 3', date: '01/02', events: [] }, { day: 'Day 4', date: '01/03', events: [] } ];
                        itinData.forEach((row, rowIndex) => {
                            let targetDayStr = row.day || row.sheetName; 
                            if (!targetDayStr) return;
                            const dayIdx = (parseInt(targetDayStr.toString().replace(/\D/g,'')) || 1) - 1;
                            if (newItinerary[dayIdx]) {
                                let cleanId = row.id ? row.id.toString().replace(/^'/, '') : 'evt_' + Date.now() + '_' + rowIndex;
                                newItinerary[dayIdx].events.push({
                                    sheetName: row.sheetName,
                                    id: cleanId, 
                                    time: row.time ? row.time.toString() : '',
                                    title: row.title || '', transport: row.transport || '', food: row.food || '', cost: row.cost || '', link: row.link || '', note: row.note || ''
                                });
                                if (row.date) newItinerary[dayIdx].date = normalizeDate(row.date);
                            }
                        });
                        state.itinerary = newItinerary;
                    }
                    if (Array.isArray(walletData)) {
                        state.expenses = walletData.map(item => {
                             let cSplit = item.customsplit;
                             if (typeof cSplit === 'string' && cSplit.startsWith('{')) {
                                try { cSplit = JSON.parse(cSplit); } catch(e){}
                             }
                             let cleanDate = normalizeDate(item.date || '12/31');
                             let cleanTime = normalizeTime(item.time);
                             
                             return {
                                ...item,
                                id: (item.w_id || item.id || generateId()).toString().replace(/^'/, ''),
                                amount: parseFloat(item.w_amount || item.amount) || 0,
                                customSplit: cSplit,
                                date: cleanDate,
                                time: cleanTime,
                                note: item.w_note || item.note || ''
                            };
                        });
                    }
                    
                    saveCache(); 
                    render();
                    if(btn) btn.innerText = 'Â∑≤Êõ¥Êñ∞';
                    if(dot) dot.className = 'w-2 h-2 rounded-full bg-sage-dark';
                })
                .catch(err => {
                    console.error("Load Error", err);
                    if(btn) btn.innerText = 'ËÆÄÂèñÂ§±Êïó';
                    if(dot) dot.className = 'w-2 h-2 rounded-full bg-func-red';
                }).finally(() => {
                    render();
                });
                
            setTimeout(() => {
                if(btn && btn.innerText === 'ËÆÄÂèñ‰∏≠...') {
                   btn.innerText = 'ÈÄ£Á∑öÈÄæÊôÇ';
                   if(dot) dot.className = 'w-2 h-2 rounded-full bg-gray-400';
                }
            }, 10000);
        }

        function loadChecklistData() {
            if (typeof Papa !== 'undefined') {
                Papa.parse(CHECKLIST_CSV_URL, {
                    download: true,
                    header: false, 
                    skipEmptyLines: true,
                    complete: function(results) {
                        const rows = results.data.slice(1); 
                        state.checklist = rows.map(r => {
                            const item = r[0] ? r[0].trim() : '';
                            const category = r[1] ? r[1].trim() : 'Êú™ÂàÜÈ°û';
                            if (!item) return null; 
                            return { item, category };
                        }).filter(i => i !== null);
                        saveCache();
                        if(state.activeTab === 'list') render();
                    },
                    error: function() { fallbackChecklistLoad(); }
                });
            } else {
                fallbackChecklistLoad();
            }
        }
        
        function fallbackChecklistLoad() {
             fetch(CHECKLIST_CSV_URL).then(r => r.text()).then(csv => {
                const rows = csv.split('\n').map(r => r.split(','));
                state.checklist = rows.slice(1).map(r => {
                    const item = r[0] ? r[0].trim() : '';
                    const category = r[1] ? r[1].trim() : 'Êú™ÂàÜÈ°û';
                    if(!item) return null;
                    return { item, category };
                }).filter(i => i !== null);
                saveCache();
                if(state.activeTab === 'list') render();
            });
        }

        function loadShopData() {
            if (typeof Papa === 'undefined') {
                console.warn("PapaParse not loaded");
                return;
            }
            Papa.parse(SHOP_CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    state.shopProducts = results.data.filter(item => {
                         const name = item['Name'] || item['ÂêçÁ®±'] || item['ÂïÜÂìÅÂêçÁ®±'];
                         return name && name.trim() !== '';
                    });
                    saveCache();
                    if(state.activeTab === 'shop') render();
                }
            });
        }

        function startShopSync() {
            if (!db) return;
            const statusRef = collection(db, 'artifacts', appId, 'public', 'data', 'shopping_list_status');
            onSnapshot(statusRef, (snapshot) => {
                state.shopPurchased = {}; 
                snapshot.forEach(doc => { state.shopPurchased[doc.id] = doc.data().isPurchased; });
                if(state.activeTab === 'shop') render();
            });
        }

        // --- Render Functions ---
        function renderPlan(c) {
             const day = state.itinerary[state.activeDay];
             day.events.sort((a, b) => {
                 if (!a.time) return -1;
                 if (!b.time) return 1;
                 return a.time.localeCompare(b.time);
             });
             
            let html = `<div class="mb-5 fade-in flex justify-between items-end"><div class="flex items-center gap-2"><h2 class="text-3xl font-black text-text-main font-title">${day.date} ${day.day}</h2></div><button onclick="window.addEvent()" class="text-xs btn-accent px-4 py-2 rounded-full font-bold transition"><i class="fa-solid fa-plus mr-1"></i>Êñ∞Â¢û</button></div><div class="space-y-4 fade-in pb-20">`;
            day.events.forEach((evt) => {
                const isExp = state.expandedEvents.includes(evt.id);
                const isEditing = state.editingEventId === evt.id;
                
                let linkUrl = evt.link || '';
                let linkText = 'ÈªûÊìäÈñãÂïü';
                if (linkUrl && linkUrl.includes(' ')) {
                    const idx = linkUrl.indexOf(' ');
                    const r = linkUrl.substring(0, idx);
                    const t = linkUrl.substring(idx + 1).trim();
                    if(r && t) { linkUrl = r; linkText = t; }
                }
                const safeLink = ensureProtocol(linkUrl);

                html += `
                <div class="ac-card ${isExp?'expanded':''} relative">
                    <div class="p-4 flex items-center gap-3 cursor-pointer" onclick="window.toggleEvent('${evt.id}')">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="bg-sage-pale text-text-sub text-[10px] font-bold px-2 py-0.5 rounded-full">${evt.time || 'Êú™ÂÆö'}</span>
                            </div>
                            <h3 class="font-bold text-text-main text-lg break-words whitespace-pre-wrap leading-tight">${evt.title}</h3>
                            ${evt.transport ? `<div class="text-xs text-text-sub mt-1 break-words"><i class="fa-solid fa-train-subway mr-1"></i>${evt.transport}</div>` : ''}
                        </div>
                        <div class="text-[#D3DCD6]"><i class="fa-solid fa-angle-down transition-transform ${isExp?'rotate-180':''}"></i></div>
                    </div>
                    <div class="plan-detail ${isExp?'expanded':''}">
                        <div class="px-5 pb-5 space-y-4 pt-2">
                `;

                if (isEditing) {
                    html += `
                            <div class="grid grid-cols-2 gap-6">
                                <div><label class="text-xs font-bold text-text-sub">ÊôÇÈñì</label><input class="ac-input" type="time" value="${evt.time}" onchange="window.updateVal('${evt.id}','time',this.value)"></div>
                                <div><label class="text-xs font-bold text-text-sub">Ë≤ªÁî®</label><input class="ac-input" type="text" value="${evt.cost}" placeholder="Ë≤ªÁî®" onchange="window.updateVal('${evt.id}','cost',this.value)"></div>
                            </div>
                            <textarea class="ac-textarea font-bold" rows="2" placeholder="Ë´ãËº∏ÂÖ•Ë°åÁ®ãÊ®ôÈ°å" onchange="window.updateVal('${evt.id}','title',this.value)">${evt.title}</textarea>
                            <textarea class="ac-textarea mt-2 resize-y" rows="2" placeholder="Ë´ãËº∏ÂÖ•‰∫§ÈÄöÊñπÂºè (ÂèØÊèõË°å)" onchange="window.updateVal('${evt.id}','transport',this.value)">${evt.transport}</textarea>
                            <div class="relative mt-2">
                                <input class="ac-input pr-10 text-func-blue underline" type="text" placeholder="Á∂≤ÂùÄ (Á©∫‰∏ÄÊ†ºÂèØËº∏ÂÖ•Ëá™Ë®ÇÂêçÁ®±)" value="${evt.link}" onchange="window.updateVal('${evt.id}','link',this.value)">
                            </div>
                            <textarea class="ac-input mt-2" rows="3" placeholder="Ë´ãËº∏ÂÖ•ÂÇôË®ª..." onchange="window.updateVal('${evt.id}','note',this.value)">${evt.note}</textarea>
                            <div class="flex justify-between pt-2">
                                <button onclick="window.askDelete('${evt.id}')" class="px-4 py-2 text-xs bg-sage-pale text-func-red rounded-full font-bold">Âà™Èô§</button>
                                <button onclick="window.saveAndClose('${evt.id}')" class="px-8 py-2 text-sm btn-primary rounded-full font-bold active:scale-95">ÂÑ≤Â≠ò</button>
                            </div>
                    `;
                } else {
                    html += `
                            <div class="space-y-2 text-text-main">
                                <div class="flex gap-2 text-sm"><span class="text-sage-dark font-bold min-w-[3rem]">Ë≤ªÁî®</span><span>${evt.cost || '--'}</span></div>
                                <div class="flex gap-2 text-sm"><span class="text-sage-dark font-bold min-w-[3rem]">‰∫§ÈÄö</span><span class="break-words whitespace-pre-wrap flex-1">${evt.transport || '--'}</span></div>
                                ${safeLink ? `
                                    <div class="flex gap-2 text-sm items-center">
                                        <span class="text-sage-dark font-bold min-w-[3rem] relative z-20">ÈÄ£Áµê</span>
                                        <a href="${safeLink}" 
                                           onclick="event.preventDefault(); event.stopPropagation(); window.open(this.href, '_blank');"
                                           class="text-func-blue underline break-all flex-1 relative z-50 pointer-events-auto cursor-pointer py-1 font-bold"
                                           target="_blank">
                                           ${linkText} <i class="fa-solid fa-arrow-up-right-from-square text-[10px] ml-1 opacity-70"></i>
                                        </a>
                                    </div>
                                ` : ''}
                                <div class="flex gap-2 text-sm"><span class="text-sage-dark font-bold min-w-[3rem]">ÂÇôË®ª</span><span class="whitespace-pre-wrap break-words flex-1 bg-sage-pale p-2 rounded-xl text-text-sub">${evt.note || 'ÁÑ°'}</span></div>
                            </div>
                            <div class="flex justify-end pt-2">
                                <button onclick="window.startEdit('${evt.id}')" class="w-10 h-10 rounded-full bg-sage-light text-sage-dark shadow-sm flex items-center justify-center hover:scale-110 transition border border-sage-dark">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                    `;
                }
                html += `</div></div></div>`;
            });
            c.innerHTML = html + `</div>`;
        }

        function renderWalletRecord(c) {
            const defaultDate = state.itinerary[state.activeDay].date;
            let h1 = `<div class="ac-card p-6 relative bg-white fade-in"><h3 class="text-base font-black text-sage-dark mb-4 flex justify-between items-center"><span>${state.editingId ? '‚úèÔ∏è Á∑®ËºØË®òÂ∏≥' : 'üìù Êñ∞Â¢ûÊ∂àË≤ª'}</span>${state.editingId ? `<button onclick="window.cancelEdit()" class="text-text-sub hover:text-func-red"><i class="fa-solid fa-xmark"></i></button>` : ''}</h3><div class="space-y-4"><div class="grid grid-cols-2 gap-3"><div class="select-wrapper col-span-2"><label class="text-xs font-bold text-text-sub ml-2">Ê∂àË≤ªÊó•Êúü</label><select id="exDate" class="ac-select"><option value="12/31" ${defaultDate==='12/31'?'selected':''}>12/31 (Day 1)</option><option value="01/01" ${defaultDate==='01/01'?'selected':''}>01/01 (Day 2)</option><option value="01/02" ${defaultDate==='01/02'?'selected':''}>01/02 (Day 3)</option><option value="01/03" ${defaultDate==='01/03'?'selected':''}>01/03 (Day 4)</option></select></div><div class="select-wrapper"><select id="exPayer" class="ac-select"><option value="ÂÖ¨Ë≤ªÊîØ‰ªò" selected>ÂÖ¨Ë≤ªÊîØ‰ªò</option>${staticData.payers.filter(p=>p!=='ÂÖ¨Ë≤ªÊîØ‰ªò').map(p=>`<option>${p}</option>`).join('')}</select></div><div class="select-wrapper"><select id="exMethod" class="ac-select"><option value="ÁèæÈáë" selected>ÁèæÈáë</option>${staticData.paymentMethods.filter(m=>m!=='ÁèæÈáë').map(m=>`<option>${m}</option>`).join('')}</select></div></div>`;
            let h2 = `<div class="relative"><div class="flex items-center gap-2 border-b-2 border-card-border pb-1 focus-within:border-sage-dark transition"><button onclick="window.toggleCurrency()" id="currBtn" class="flex-shrink-0 w-12 text-sm font-bold text-text-sub px-2 py-1 hover:text-sage-dark transition border-r-2 border-gray-100">${state.expenseCurrency==='KRW'?'‚Ç©':'NT$'}</button><input type="number" id="exAmt" placeholder="0" class="flex-1 min-w-0 text-xl font-bold text-right outline-none bg-transparent" oninput="window.autoCalcSplit('total')"><button onclick="window.openCalc()" class="flex-shrink-0 w-10 text-text-sub hover:text-sage-dark p-2"><i class="fa-solid fa-calculator text-lg"></i></button></div></div><div class="select-wrapper"><select id="exSplit" class="ac-select" onchange="window.toggleUneven(this.value)"><option value="Âπ≥ÂùáÂàÜÊî§" selected>Âπ≥ÂùáÂàÜÊî§</option><option value="‰∏çÂπ≥ÂùáÂàÜÊî§">‰∏çÂπ≥ÂùáÂàÜÊî§</option></select></div><div id="unevenBox" class="hidden grid grid-cols-2 gap-3 bg-sage-pale p-3 rounded-3xl border-2 border-dashed border-[#D3DCD6]"><div><label class="text-xs font-bold text-text-sub mb-1 pl-1">ü¶Å Andy</label><input type="number" id="spAndy" class="w-full bg-white rounded-3xl p-2 text-sm text-center border-2 border-[#D3DCD6] font-bold outline-none focus:border-ac-blue" oninput="window.autoCalcSplit('andy')"></div><div><label class="text-xs font-bold text-text-sub mb-1 pl-1">üê± Lynn</label><input type="number" id="spLynn" class="w-full bg-white rounded-3xl p-2 text-sm text-center border-2 border-[#D3DCD6] font-bold outline-none focus:border-func-red" oninput="window.autoCalcSplit('lynn')"></div></div>`;
            let h3 = `<div class="grid grid-cols-2 gap-3"><div class="select-wrapper"><select id="exCat" class="ac-select"><option value="È§êÈ£≤" selected>È§êÈ£≤</option>${staticData.categories.filter(c=>c!=='È§êÈ£≤').map(c=>`<option>${c}</option>`).join('')}</select></div><input type="time" id="exTime" class="ac-input text-center font-mono"></div><input type="text" id="exName" placeholder="ÂìÅÈ†ÖÂêçÁ®± (ÈÅ∏Â°´)" class="ac-input input-gray-border text-base"><textarea id="exNote" class="ac-input input-gray-border" rows="2" placeholder="ÂÇôË®ª..."></textarea><button onclick="window.submitExpense()" id="btnSubmit" class="ac-btn w-full btn-primary py-3.5 text-lg rounded-3xl bg-sage-dark text-white shadow-md hover:opacity-90 active:scale-95 transition border-2 border-sage-dark">${state.editingId ? 'Êõ¥Êñ∞Á¥ÄÈåÑ' : 'Á¢∫Ë™çÈÄÅÂá∫'}</button></div></div><div class="text-center mt-6"><button onclick="window.openDepositModal()" class="text-sm font-bold text-ac-brown underline hover:text-sage-dark">üí∞ ÂÖ¨Ë≤ªÂÖ•Èáë</button></div>`;
            c.innerHTML = h1 + h2 + h3;
            
            if(state.editingId) {
                const item = state.expenses.find(e => e.id === state.editingId);
                if(item) {
                    const nDate = normalizeDate(item.date || '12/31');
                    document.getElementById('exDate').value = nDate;
                    document.getElementById('exAmt').value = item.amount;
                    document.getElementById('exName').value = item.name || '';
                    document.getElementById('exCat').value = item.cat;
                    document.getElementById('exPayer').value = item.payer;
                    document.getElementById('exMethod').value = item.method;
                    document.getElementById('exTime').value = item.time;
                    document.getElementById('exSplit').value = item.split;
                    if(item.split === '‰∏çÂπ≥ÂùáÂàÜÊî§') {
                        document.getElementById('unevenBox').classList.remove('hidden');
                        if(item.customSplit) {
                            document.getElementById('spAndy').value = item.customSplit.andy;
                            document.getElementById('spLynn').value = item.customSplit.lynn;
                        }
                    }
                    if(item.note) document.getElementById('exNote').value = item.note;
                    state.expenseCurrency = item.currency || 'KRW';
                    document.getElementById('currBtn').innerText = state.expenseCurrency === 'KRW' ? '‚Ç©' : 'NT$';
                }
            } else { document.getElementById('exTime').value = new Date().toTimeString().slice(0,5); }
        }

        function renderWalletDetails(c) {
            let publicFundTotal = 0; let andyDeposit = 0; let lynnDeposit = 0;
            let andyTotalConsum = 0; let lynnTotalConsum = 0;
            let andyAdvance = 0; let lynnAdvance = 0;
            let depositList = [];

            state.expenses.forEach(e => {
                const payer = e.payer || '';
                let amt = e.currency === 'TWD' ? e.amount / config.currencyRate : e.amount;

                if(e.cat === 'ÂÖ¨Ë≤ªÂÖ•Èáë' || e.cat.includes('ÂÖ•Èáë')) {
                    depositList.push(e);
                    publicFundTotal += amt;
                    if(payer.includes('ü¶Å') || payer.includes('Andy')) andyDeposit += amt;
                    else if(payer.includes('üê±') || payer.includes('Lynn')) lynnDeposit += amt;
                    else { andyDeposit += amt/2; lynnDeposit += amt/2; }
                } else {
                    let splitAndy = 0; let splitLynn = 0;
                    if(e.split === '‰∏çÂπ≥ÂùáÂàÜÊî§' && e.customSplit) {
                        splitAndy = e.currency==='TWD' ? e.customSplit.andy/config.currencyRate : e.customSplit.andy;
                        splitLynn = e.currency==='TWD' ? e.customSplit.lynn/config.currencyRate : e.customSplit.lynn;
                    } else { splitAndy = amt/2; splitLynn = amt/2; }

                    if(payer === 'ÂÖ¨Ë≤ªÊîØ‰ªò') { publicFundTotal -= amt; }
                    else if(payer.includes('Andy') || payer.includes('ü¶Å')) { andyAdvance += splitLynn; }
                    else if(payer.includes('Lynn') || payer.includes('üê±')) { lynnAdvance += splitAndy; }
                    
                    andyTotalConsum += splitAndy; lynnTotalConsum += splitLynn;
                }
            });

            const andyEquity = andyDeposit - (andyTotalConsum - (andyAdvance + (state.expenses.filter(e=>e.payer && e.payer.includes('Andy') && e.cat!=='ÂÖ¨Ë≤ªÂÖ•Èáë').reduce((s,x)=>s+(x.currency==='TWD'?x.amount/config.currencyRate:x.amount),0) - andyAdvance))); 
            const lynnEquity = lynnDeposit - (lynnTotalConsum - (lynnAdvance + (state.expenses.filter(e=>e.payer && e.payer.includes('Lynn') && e.cat!=='ÂÖ¨Ë≤ªÂÖ•Èáë').reduce((s,x)=>s+(x.currency==='TWD'?x.amount/config.currencyRate:x.amount),0) - lynnAdvance)));
            
            let list = [];
            let displayTitle = '';
            if (state.walletDay === 'all') {
                displayTitle = 'ÂÖ®ÈÉ®Ê∂àË≤ªÊòéÁ¥∞';
                list = state.expenses.filter(e => e.cat !== 'ÂÖ¨Ë≤ªÂÖ•Èáë').slice().reverse();
                list.sort((a,b) => (b.date||'').localeCompare(a.date||''));
            } else {
                const targetDate = state.itinerary[state.walletDay] ? state.itinerary[state.walletDay].date : '12/31';
                displayTitle = `${targetDate} Ê∂àË≤ªÊòéÁ¥∞`;
                list = state.expenses.filter(e => { const d = e.date || '12/31'; return d === targetDate; }).slice().reverse();
            }

            let dailyTotal = list.reduce((sum, e) => { if(e.cat === 'ÂÖ¨Ë≤ªÂÖ•Èáë') return sum; return sum + (e.currency === 'TWD' ? e.amount / config.currencyRate : e.amount); }, 0);
            let dailyTotalTwd = dailyTotal * config.currencyRate;
            
            let andyTotalConsumTwd = andyTotalConsum * config.currencyRate;
            let andyAdvanceTwd = andyAdvance * config.currencyRate;
            let lynnTotalConsumTwd = lynnTotalConsum * config.currencyRate;
            let lynnAdvanceTwd = lynnAdvance * config.currencyRate;

            depositList.sort((a,b) => (b.date || '').localeCompare(a.date || ''));

            let html = `
                <div class="fade-in pb-24">
                    <div class="ac-card p-5 mb-4 bg-white">
                        <div class="flex justify-between items-center mb-3 pb-2 border-b-2 border-[#E4EFE8]">
                            <div><div class="text-xs text-text-sub font-bold">üí∞ ÂÖ¨Ë≤ªÈ§òÈ°ç</div><div class="text-xl font-black text-sage-dark">‚Ç©${formatMoney(publicFundTotal)} <span class="text-xs text-gray-400 font-medium">‚âàNT$${formatMoney(publicFundTotal*config.currencyRate)}</span></div></div>
                            <div class="text-right flex gap-3">
                                <div><div class="text-[10px] text-text-sub">ü¶Å Andy</div><div class="text-xs font-bold text-sage-dark">‚Ç©${formatMoney(andyEquity)}</div></div>
                                <div><div class="text-[10px] text-text-sub">üê± Lynn</div><div class="text-xs font-bold text-sage-dark">‚Ç©${formatMoney(lynnEquity)}</div></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="border-r-2 border-[#E4EFE8] space-y-2">
                                <div class="text-lg mb-1">ü¶Å</div>
                                <div class="text-xs text-text-sub font-bold">üí∏ ÂÄã‰∫∫Ê∂àË≤ª</div><div class="text-sm font-black text-text-main">‚Ç©${formatMoney(andyTotalConsum)} <span class="text-[10px] text-gray-400 block sm:inline">‚âàNT$${formatMoney(andyTotalConsumTwd)}</span></div>
                                <div class="text-xs text-text-sub font-bold mt-1">üí≥ ‰ª£Â¢ä</div><div class="text-sm font-black text-ac-blue">‚Ç©${formatMoney(andyAdvance)} <span class="text-[10px] text-gray-400 block sm:inline">‚âàNT$${formatMoney(andyAdvanceTwd)}</span></div>
                            </div>
                            <div class="space-y-2">
                                <div class="text-lg mb-1">üê±</div>
                                <div class="text-xs text-text-sub font-bold">üí∏ ÂÄã‰∫∫Ê∂àË≤ª</div><div class="text-sm font-black text-text-main">‚Ç©${formatMoney(lynnTotalConsum)} <span class="text-[10px] text-gray-400 block sm:inline">‚âàNT$${formatMoney(lynnTotalConsumTwd)}</span></div>
                                <div class="text-xs text-text-sub font-bold mt-1">üí≥ ‰ª£Â¢ä</div><div class="text-sm font-black text-func-red">‚Ç©${formatMoney(lynnAdvance)} <span class="text-[10px] text-gray-400 block sm:inline">‚âàNT$${formatMoney(lynnAdvanceTwd)}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                         <div class="flex justify-between items-end px-2 mb-2"><h4 class="text-xs font-bold text-text-sub">${displayTitle}</h4><span class="text-xs font-black text-ac-brown bg-sage-light px-2 py-1 rounded-lg">Â∞èË®à: ‚Ç©${formatMoney(dailyTotal)} <span class="text-[10px] text-gray-500">‚âàNT$${formatMoney(dailyTotalTwd)}</span></span></div>
                         ${list.length === 0 ? '<div class="text-center text-text-sub py-6 text-sm font-bold border-2 border-dashed border-[#D3DCD6] rounded-3xl">üçÇ ÁÑ°Ê∂àË≤ªÁ¥ÄÈåÑ</div>' : ''}
                         ${list.map(e => {
                             const isDeposit = e.cat === 'ÂÖ¨Ë≤ªÂÖ•Èáë'; const payer = e.payer || '';
                             const twdVal = e.currency === 'KRW' ? e.amount * config.currencyRate : null;
                             return `<div class="ac-card p-3 flex justify-between items-center group relative overflow-hidden ${isDeposit ? 'bg-func-yellow/10 border-func-yellow/50' : ''}"><div class="absolute left-0 top-0 bottom-0 w-2 ${isDeposit ? 'bg-func-yellow' : (payer.includes('Andy')?'bg-ac-blue':payer.includes('Lynn')?'bg-func-red':'bg-gray-300')}"></div><div class="pl-3"><div class="flex items-center gap-2 mb-0.5"><span class="text-[10px] text-text-sub font-mono bg-gray-100 px-1.5 rounded">${e.date}</span><span class="text-[10px] text-text-sub font-mono">${e.time || '--:--'}</span></div><div class="font-bold text-text-main text-base mb-1 flex items-center gap-1">${isDeposit ? 'üí∞ ' : ''}${e.name || e.cat}</div><div class="flex flex-wrap gap-1 text-[10px] text-text-sub font-bold"><span class="bg-sage-pale px-2 py-0.5 rounded-md">${payer}</span>${e.note?`<span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded-md">${e.note}</span>`:''}</div></div><div class="text-right"><div class="font-mono font-black ${isDeposit ? 'text-func-yellow' : 'text-func-red'} text-lg">${e.currency} ${formatMoney(e.amount)}</div>${twdVal ? `<div class="text-[10px] text-gray-400 font-bold">‚âàNT$${formatMoney(twdVal)}</div>` : ''}<div class="flex gap-2 justify-end mt-2 items-center">${!isDeposit ? `<button onclick="window.editExpense('${e.id}')" class="text-sage-dark hover:scale-110 mr-1"><i class="fa-solid fa-pen"></i></button>` : ''}<button onclick="window.deleteExpense('${e.id}')" class="text-func-red hover:scale-110 mr-2"><i class="fa-solid fa-trash-can"></i></button></div></div></div>`}).join('')}
                    </div>
                    
                    <div class="mt-10 mb-8 px-2">
                        <h4 class="text-sm font-black text-sage-dark mb-4 flex items-center gap-2 border-b-2 border-dashed border-[#D3DCD6] pb-2 w-fit pr-4"><i class="fa-solid fa-piggy-bank"></i> ÂÖ¨Ë≤ªÂÑ≤ÂÄºÁ¥ÄÈåÑ</h4>
                        <div class="space-y-3">
                        ${depositList.length > 0 ? depositList.map(e => `<div class="bg-func-yellow/10 border-2 border-func-yellow/20 rounded-2xl p-3 flex justify-between items-center relative overflow-hidden"><div class="absolute right-0 top-0 text-6xl text-func-yellow/10 -mr-2 -mt-2"><i class="fa-solid fa-coins"></i></div><div class="relative z-10"><div><span class="text-[10px] font-mono text-func-yellow bg-white/80 px-2 py-0.5 rounded-md">${e.date}</span></div><div class="font-bold text-text-main text-sm mt-1">ÂÖ¨Ë≤ªÂÖ•Èáë</div><div class="text-[10px] text-text-sub mt-0.5 opacity-70">${e.payer}</div></div><div class="text-right relative z-10"><div class="font-black text-func-yellow text-lg">‚Ç©${formatMoney(e.amount)}</div><button onclick="window.deleteExpense('${e.id}')" class="text-func-red text-xs mt-1 hover:underline opacity-60 hover:opacity-100">Âà™Èô§</button></div></div>`).join('') : '<div class="text-center text-gray-400 text-xs py-4 border-2 border-dashed border-[#E4EFE8] rounded-2xl">ÁÑ°ÂÑ≤ÂÄºÁ¥ÄÈåÑ</div>'}
                        </div>
                    </div>
                </div>`;
            c.innerHTML = html;
        }

        function renderShop(c) {
            const list = state.shopFilter === 'All' ? state.shopProducts : state.shopProducts.filter(i => (i['Location']||i['Âú∞Èªû']||'').trim() === state.shopFilter);
            if(list.length === 0) { c.innerHTML = '<div class="text-center text-text-sub mt-10">Â∞öÁÑ°ÂïÜÂìÅË≥áÊñô</div>'; return; }

            let html = `<div class="shop-grid">`;
            list.forEach(item => {
                const name = (item['Name'] || item['ÂêçÁ®±'] || item['ÂïÜÂìÅÂêçÁ®±'] || '').trim().replace(/'/g, "\\'");
                const desc = item['Description'] || item['ÊèèËø∞'] || '';
                const imageRaw = item['Image'] || item['image'] || item['ÂúñÁâá'] || '';
                const gid = getGoogleDriveId(imageRaw);
                const isPurchased = state.shopPurchased[name];
                
                let imgTag = `<div class="w-full h-full bg-[#E5E5E5] flex items-center justify-center text-xs text-gray-400">No Image</div>`;
                if(gid) imgTag = `<img src="https://lh3.googleusercontent.com/d/${gid}=s400" class="w-full h-full object-cover" loading="lazy" onerror="this.src='https://placehold.co/200?text=No+Image'">`;
                else if(imageRaw) imgTag = `<img src="${imageRaw}" class="w-full h-full object-cover" loading="lazy">`;

                html += `
                <div class="shop-card ${isPurchased ? 'purchased' : ''}">
                    <div class="shop-card-img-container">
                        ${imgTag}
                        <div class="badge-purchased">Purchased</div>
                        <div class="check-circle" onclick="window.toggleShopItem(event, '${name}')"></div>
                    </div>
                    
                    <div class="shop-card-body">
                        <h4 class="text-[#3E5F52] font-[600] text-sm leading-tight mb-2 whitespace-normal break-words">${name}</h4>
                        <p class="text-[#6F8F83] text-xs whitespace-normal break-words leading-relaxed">${desc}</p>
                    </div>
                </div>`;
            });
            html += `</div>`;
            c.innerHTML = html;
        }
        
        function renderList(c) {
            const groups = {};
            state.checklist.forEach(i => {
                if(!i || !i.category) return;
                if(!groups[i.category]) groups[i.category] = [];
                // Fix: Push the item string directly, NOT an object
                groups[i.category].push(i.item); 
            });

            let html = `<div class="pb-24 fade-in space-y-4">`;
            for(let cat in groups) {
                const isExpanded = state.expandedCategories.includes(cat);
                const arrowClass = isExpanded ? 'rotate-180' : '';
                const contentClass = isExpanded ? '' : 'hidden';
                
                html += `
                <div class="bg-white rounded-[1.5rem] shadow-sm border-2 border-[#EFF3F1] overflow-hidden transition-all duration-300">
                    <div onclick="window.toggleCategory('${cat}')" class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50 transition select-none">
                        <h3 class="font-black text-lg text-sage-dark flex items-center gap-2">
                            <i class="fa-solid fa-list-check text-base opacity-70"></i> ${cat}
                            <span class="text-xs bg-sage-pale text-sage-dark px-2 py-0.5 rounded-full ml-1">${groups[cat].length}</span>
                        </h3>
                        <div class="w-8 h-8 rounded-full bg-sage-pale flex items-center justify-center text-sage-dark transition-transform duration-300 ${arrowClass}">
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                    </div>
                    
                    <div class="${contentClass} px-4 pb-4 pt-0 border-t border-dashed border-[#E4EFE8]">
                        <div class="pt-3 space-y-2">`;
                        
                groups[cat].forEach(itemText => {
                    const checked = state.checkedItems[itemText] ? 'checked' : '';
                    html += `
                    <label class="cb-container">
                        <input type="checkbox" ${checked} onchange="window.toggleCheck('${itemText}')">
                        <span class="checkmark"></span>
                        <span class="item-text font-bold text-sm text-[#3E5F52]">${itemText}</span>
                    </label>`;
                });
                
                html += `   </div>
                    </div>
                </div>`;
            }
            
            if(Object.keys(groups).length === 0) {
                html += `<div class="text-center text-gray-400 mt-10 py-10 border-2 border-dashed border-[#D3DCD6] rounded-3xl">ËºâÂÖ•Ê∏ÖÂñÆ‰∏≠...</div>`;
            }
            
            html += `</div>`;
            c.innerHTML = html;
        }

        function render() {
            try {
                const app = document.getElementById('app');
                if(!app) return;
                
                const dayTabs = document.getElementById('dayTabsContainer');
                const walletTabs = document.getElementById('walletToggleWrapper');
                const shopTabs = document.getElementById('shopTabsContainer'); 

                if(dayTabs) { dayTabs.classList.add('hidden'); dayTabs.classList.remove('day-tabs-container'); }
                if(walletTabs) walletTabs.classList.add('hidden');
                if(shopTabs) shopTabs.classList.add('hidden');
                app.innerHTML = '';
                
                app.className = "safe-top-padding px-4 max-w-md mx-auto relative z-10 pt-48";

                if(state.activeTab === 'plan') {
                    if(dayTabs) {
                        dayTabs.innerHTML = state.itinerary.map((d, i) => `<div onclick="window.switchDay(${i})" class="day-pill ${i === state.activeDay ? 'active' : ''}">${d.day}</div>`).join('');
                        dayTabs.classList.remove('hidden'); dayTabs.classList.add('day-tabs-container');
                    }
                    renderPlan(app);
                } 
                else if(state.activeTab === 'wallet') {
                    if(walletTabs) walletTabs.classList.remove('hidden');
                    const sw = document.getElementById('walletToggle');
                    if(state.walletMode === 'record') { 
                        if(sw) { sw.classList.add('mode-record'); sw.classList.remove('mode-details'); }
                        app.className = "safe-top-padding px-4 max-w-md mx-auto relative z-10 pt-52";
                        renderWalletRecord(app); 
                    } else { 
                        if(dayTabs) {
                            let tabsHtml = `<div onclick="window.switchDay('all')" class="day-pill ${state.walletDay === 'all' ? 'active' : ''}">ÂÖ®ÈÉ®</div>`;
                            tabsHtml += state.itinerary.map((d, i) => `<div onclick="window.switchDay(${i})" class="day-pill ${i === state.walletDay ? 'active' : ''}">${d.day}</div>`).join('');
                            dayTabs.innerHTML = tabsHtml;
                            dayTabs.classList.remove('hidden'); dayTabs.classList.add('day-tabs-container');
                        }
                        if(sw) { sw.classList.remove('mode-record'); sw.classList.add('mode-details'); }
                        app.className = "safe-top-padding px-4 max-w-md mx-auto relative z-10 pt-52";
                        renderWalletDetails(app); 
                    }
                }
                else if(state.activeTab === 'list') {
                    app.className = "safe-top-padding px-4 max-w-md mx-auto relative z-10 pt-24";
                    renderList(app);
                }
                else if(state.activeTab === 'shop') {
                    if(shopTabs) shopTabs.classList.remove('hidden');
                    setupShopTabs();
                    app.className = "safe-top-padding px-4 max-w-md mx-auto relative z-10 pt-40";
                    renderShop(app);
                }
            } catch(e) {
                console.error("Render error:", e);
                document.getElementById('app').innerHTML = `<div class="text-red-500 p-4">Ê∏≤ÊüìÈåØË™§: ${e.message}</div>`;
            }
        }

        // Attach global functions to window at the end
        window.toggleWalletMode = toggleWalletMode;
        window.toggleCurrency = toggleCurrency;
        window.toggleUneven = toggleUneven;
        window.autoCalcSplit = autoCalcSplit;
        window.submitExpense = submitExpense;
        window.openDepositModal = openDepositModal;
        window.setDepositSource = setDepositSource;
        window.submitDeposit = submitDeposit;
        window.deleteExpense = deleteExpense;
        window.editExpense = editExpense;
        window.cancelEdit = cancelEdit;
        window.openCalc = openCalc;
        window.closeCalc = closeCalc;
        window.calcAppend = calcAppend;
        window.calcClear = calcClear;
        window.calcBackspace = calcBackspace;
        window.calcConfirm = calcConfirm;
        window.toggleEvent = toggleEvent;
        window.startEdit = startEdit;
        window.updateVal = updateVal;
        window.saveAndClose = saveAndClose;
        window.addEvent = addEvent;
        window.askDelete = askDelete;
        window.confirmDelete = confirmDelete;
        window.toggleCheck = toggleCheck;
        window.toggleCategory = toggleCategory;
        window.filterShop = filterShop;
        window.switchDay = switchDay;
        window.toggleShopItem = toggleShopItem;
        window.router = router;
        window.loadAllData = loadAllData;
        window.render = render;

        // Init
        try {
            // Force immediate render to prevent white screen
            window.render(); 
        } catch(e) { console.error("Initial render failed", e); }
        
        loadAllData(); // Then fetch
    </script>
</body>
</html>